#! /usr/bin/env bash

testname=$(echo "$1" | sed 's/[^a-zA-Z0-9]/_/g')

preserve_container_state_client() {
    # Nothing so far
    :
}

preserve_container_state() {
    local name="$1"
    local container="${testname}__${name}_1"
    local prefix="services/$name/artifacts"

    if docker ps -a | grep -q "$container"; then
        mkdir -p "$prefix/var"
        docker cp "$container:/usr/local/zeek/var/lib" "$prefix/var/lib"
        docker cp "$container:/usr/local/zeek/spool" "$prefix/spool"
        docker cp "$container:/usr/local/zeek/logs" "$prefix/logs"
    fi
}

# Preserve the containers' persistent state. If there's a service-specific
# routine, use that, otherwise handle generically.
for service in $(docker compose config --services); do
    if [[ $(type -t "preserve_container_state_$service") == function ]]; then
        preserve_container_state_$service
    else
        preserve_container_state $service
    fi
done

# Grab the Docker logs
docker compose -p ${testname}_ -f docker-compose.yml logs >docker-compose.logs

[ -n "$TEST_SKIP_DOCKER_TEARDOWN" ] && exit 0
[ "$TEST_FAILED" -eq 1 ] && [ -n "$TEST_SKIP_DOCKER_TEARDOWN_ON_FAILURE" ] && exit 0

if [ -z "$testname" ]; then
    echo "WARNING: btest teardown got no test name"
    exit 0
fi

if [ ! -f docker-compose.yml ]; then
    echo "WARNING: btest teardown found no docker-compose.yml"
    exit 0
fi

# Don't wait at all for clean container shutdown
docker compose -p ${testname}_ -f docker-compose.yml down -t 0

exit 0
